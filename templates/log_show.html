{% extends 'base.html' %}
{% block content %}

<div class="row">
    <div class="col-lg-12">
        <h3 class="page-header">查看日志</h3>
    </div>
</div>
<style>
    html, body {
        font: normal 0.9em arial, helvetica;
    }
    #log {
        width: 440px;
        height: 200px;
        border: 1px solid #7F9DB9;
        overflow: auto;

    }
    #msg {
        width: 330px;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div id="log" style="width: 100%"></div>
        <br>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <input type="button" class="btn btn-primary btn-sm" value="start" id="start" onclick="start()">
        <input disabled="disabled" type="button" class="btn btn-primary btn-sm" value="stop" id="stop" onclick="stop()" >
    </div>
</div>

<script>
    var socket;
    function start() {
        var host = "ws://127.0.0.1:12345/";
        try {
            socket = new WebSocket(host);
            socket.onopen = function (msg) {
                log('Connect Successfully!');           //log() 是下面的函数
            };
            socket.onmessage = function (msg) {
                log(msg.data);                           // 服务器发给浏览器的数据
            };
            socket.onclose = function () {
                log("Lose Connection!");
                $("#start").attr('disabled', false);
                $("#stop").attr('disabled', true);
            };
            $("#start").attr('disabled', true);
            $("#stop").attr('disabled', false);
        }
        catch (ex) {
            log(ex);
        }
        $("msg").focus();
    }

    function stop() {
        try {
            log('Close connection!');
            socket.send('quit');
            socket.close();
            socket = null;
            $("#start").attr('disabled', false);
            $("#stop").attr('disabled', true);
        }
        catch (ex) {
            log(ex);
        }
    }

    function send() {     // 发送给服务器
        var txt, msg, ws_state;
        txt = $("#msg");    //$(id) 下面的函数
        msg = txt.val();

        try {
            ws_state = socket.readyState;
            log(msg);
            if (ws_state == 1){
                if (!msg) {
                    alert("Message can not be empty");
                    return;
                }
                txt.val("");
                txt.focus();
                try {
                    socket.send(msg);
                } catch (ex) {
                    log(ex);
                }
            }
            else{
                alert("Connection is not active!");
            }
        } catch (ex) {
            log(ex);
        }
    }

    window.onbeforeunload = function () {
        try {
            socket.send('quit');
            socket.close();
            socket = null;
        }
        catch (ex) {
            log(ex);
        }
    };

    function $(id) {
        return document.getElementById(id);
    }
    function log(msg) {
        var obje = document.getElementById("log");
        obje.innerHTML += "<br>" + msg;
        obje.scrollTop = obje.scrollHeight;   //滚动条显示最新数据
    }
    function onkey(event) {
        if (event.keyCode == 13) {     //如果是按回车键就发送
            send();
        }
    }
</script>

{% endblock %}